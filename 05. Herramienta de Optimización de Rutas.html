<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Optimización de Rutas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: calc(100vh - 220px);
            border-radius: 0.5rem;
        }
        .leaflet-container {
            background: #f9fafb;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .filter-container {
            max-height: 150px;
            overflow-y: auto;
        }
        .leaflet-container.crosshair-cursor-enabled {
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="bg-white shadow-md rounded-lg p-6 mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Optimizador de Rutas de Instalación</h1>
            <p class="text-gray-600 mt-1">Seleccione los filtros y genere una ruta, o seleccione un área directamente en el mapa.</p>
        </header>

        <div class="bg-white shadow-md rounded-lg p-6 mb-4">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-start">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Trabajo</label>
                    <div id="work-type-filters" class="filter-container space-y-2 p-3 border rounded-md bg-gray-50">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <div class="md:col-span-2">
                     <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Zona Geográfica</label>
                    </div>
                    <div id="zone-filters" class="filter-container space-y-2 p-3 border rounded-md bg-gray-50">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>
                <div class="self-end w-full space-y-2">
                     <button id="draw-area-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-md shadow-sm transition duration-300 ease-in-out flex items-center justify-center h-10">
                        Dibujar Área en Mapa
                    </button>
                    <button id="generate-route-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out flex items-center justify-center h-10">
                        <svg id="search-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generar Ruta por Zona
                    </button>
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div id="map-container" class="lg:col-span-2 bg-white shadow-md rounded-lg p-4">
                <div id="map"></div>
            </div>
            <div id="route-details-container" class="bg-white shadow-md rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-semibold">Detalles de la Ruta</h2>
                    <a id="google-maps-btn" href="#" target="_blank" class="hidden bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1 px-3 border border-gray-300 rounded-lg shadow-sm text-sm transition duration-300 ease-in-out flex items-center">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64H348.7c2.2 20.4 3.3 41.8 3.3 64z M512 256c0 141.4-114.6 256-256 256S0 397.4 0 256S114.6 0 256 0S512 114.6 512 256z M106.2 320h299.6c-18.1 63.4-60.8 113.7-114.8 136.2C237 435.3 181.8 394.3 140.2 342.3c-6-7.5-11.4-15.3-16.3-23.5L106.2 320z M348.7 128H163.3c23.3-42.9 66.8-74 117.4-82.6C312.8 56.4 340.9 86.1 348.7 128z"></path></svg>
                        <span>Ver en Google Maps</span>
                    </a>
                </div>
                <div id="route-summary" class="text-sm text-gray-600 mb-4 border-b pb-2">
                    Seleccione los filtros y haga clic en "Generar Ruta" para ver los detalles.
                </div>
                <div id="route-list" class="overflow-y-auto" style="max-height: calc(100vh - 350px);">
                    <!-- Route stops will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA STORE ---
        const LOCATIONS = [
            {"clave":"5","Name":"FARO","Address":"Rua Pé da Cruz Nº. 14 - R/C Esquerdo Faro","TIPO_DE_TRABALHO":"Integración","lat":37.016335,"lon":-7.934827,"gmapsAddress":"Rua Pé da Cruz 14, Faro, Portugal"},
            {"clave":"15","Name":"ALMADA","Address":"Av. D. Nuno Álvares Pereira Nº.11-A/B Almada","TIPO_DE_TRABALHO":"Integración","lat":38.679193,"lon":-9.159496,"gmapsAddress":"Av. D. Nuno Álvares Pereira 11, Almada, Portugal"},
            {"clave":"23","Name":"PORTIMAO","Address":"Av. Brasil - Urbanização Quinta da Palmeira Lote 2 - Loja 2 Portimão","TIPO_DE_TRABALHO":"Integración","lat":37.132808,"lon":-8.54133,"gmapsAddress":"Av. Brasil, Quinta da Palmeira, Lote 2, Portimão, Portugal"},
            {"clave":"25","Name":"ÉVORA","Address":"Avenida Dinis Miranda Nº. 104 - Urbanização da Muralha Évora","TIPO_DE_TRABALHO":"Integración","lat":38.564491,"lon":-7.904832,"gmapsAddress":"Avenida Dinis Miranda 104, Évora, Portugal"},
            {"clave":"55","Name":"LOULÉ","Address":"Av. José da Costa Mealha Nº. 131 Loja A Loulé","TIPO_DE_TRABALHO":"Integración","lat":37.140888,"lon":-8.022379,"gmapsAddress":"Av. José da Costa Mealha 131, Loulé, Portugal"},
            {"clave":"90","Name":"VIMIEIRO","Address":"Rua da Antiga E.N. Nº. 4 - Loja 1 Vimieiro","TIPO_DE_TRABALHO":"Integración","lat":38.79673,"lon":-7.98632,"gmapsAddress":"Rua da Antiga E.N. 4, Vimieiro, Portugal"},
            {"clave":"116","Name":"ALBUFEIRA","Address":"Cerro da Alagoa - Rua do Município Lote 31 Loja 12 Albufeira","TIPO_DE_TRABALHO":"Integración","lat":37.090332,"lon":-8.243549,"gmapsAddress":"Rua do Município, Lote 31, Albufeira, Portugal"},
            {"clave":"129","Name":"PAIVAS","Address":"Rua Movimento das Forças Armadas Nº. 21 - R/C Esquerdo Paivas","TIPO_DE_TRABALHO":"Integración","lat":38.636658,"lon":-9.136863,"gmapsAddress":"Rua Movimento das Forças Armadas 21, Amora, Portugal"},
            {"clave":"130","Name":"MONTIJO","Address":"Rua Almirante Cândido Reis Nºs. 28/32 Montijo","TIPO_DE_TRABALHO":"Integración","lat":38.705828,"lon":-8.974447,"gmapsAddress":"Rua Almirante Cândido Reis 28, Montijo, Portugal"},
            {"clave":"138","Name":"ALMANCIL","Address":"Av. 5 de Outubro Lote 2 - Edifício Bia Almancil","TIPO_DE_TRABALHO":"Integración","lat":37.08696,"lon":-8.03158,"gmapsAddress":"Av. 5 de Outubro, Lote 2, Almancil, Portugal"},
            {"clave":"153","Name":"CARNAXIDE","Address":" Rua Fernão Lopes Nº. 1 - Loja A/B Carnaxide","TIPO_DE_TRABALHO":"Integración","lat":38.71887,"lon":-9.23933,"gmapsAddress":"Rua Fernão Lopes 1, Carnaxide, Portugal"},
            {"clave":"156","Name":"TOMAR","Address":" Avenida General Tamagnini de Abreu Nº. 23 Tomar","TIPO_DE_TRABALHO":"Integración","lat":39.60105,"lon":-8.41169,"gmapsAddress":"Avenida General Tamagnini de Abreu 23, Tomar, Portugal"},
            {"clave":"158","Name":"SACAVÉM","Address":"Rua Estado da Índia - Quinta do Património - Nº. 30 Loja D Sacavém","TIPO_DE_TRABALHO":"Integración","lat":38.794627,"lon":-9.103988,"gmapsAddress":"Rua Estado da Índia 30, Sacavém, Portugal"},
            {"clave":"167","Name":"RIO MAIOR","Address":" Rua de São Gregório LOTE 613 Rio Maior","TIPO_DE_TRABALHO":"Integración","lat":39.33649,"lon":-8.93818,"gmapsAddress":"Rua de São Gregório, Lote 613, Rio Maior, Portugal"},
            {"clave":"173","Name":"OEIRAS","Address":" Rua Oeiras do Piaui Nº. 15 Oeiras","TIPO_DE_TRABALHO":"Integración","lat":38.69222,"lon":-9.31346,"gmapsAddress":"Rua Oeiras do Piaui 15, Oeiras, Portugal"},
            {"clave":"177","Name":"BATALHA","Address":" Largo Goa Damão e Diu Nº. 1 Batalha","TIPO_DE_TRABALHO":"Integración","lat":39.65922,"lon":-8.82521,"gmapsAddress":"Largo Goa Damão e Diu 1, Batalha, Portugal"},
            {"clave":"180","Name":"NAZARÉ","Address":" Largo Comandante Cândido dos Reis Bloco A Lote 1 - R/C Nazaré","TIPO_DE_TRABALHO":"Integración","lat":39.60195,"lon":-9.07005,"gmapsAddress":"Largo Comandante Cândido dos Reis, Nazaré, Portugal"},
            {"clave":"191","Name":"BENEDITA","Address":" Rua da Serradinha Nº. 28 - R/C Esquerdo Benedita","TIPO_DE_TRABALHO":"Integración","lat":39.40939,"lon":-9.01893,"gmapsAddress":"Rua da Serradinha 28, Benedita, Portugal"},
            {"clave":"196","Name":"PORTO DE MÓS","Address":" Avenida da Igreja Nº. 11 - R/C Porto de Mós","TIPO_DE_TRABALHO":"Integración","lat":39.60155,"lon":-8.81885,"gmapsAddress":"Avenida da Igreja 11, Porto de Mós, Portugal"},
            {"clave":"201","Name":"ESTORIL","Address":" Av. de Nice Nº. 68-B Estoril","TIPO_DE_TRABALHO":"Integración","lat":38.70613,"lon":-9.3957,"gmapsAddress":"Av. de Nice 68-B, Estoril, Portugal"},
            {"clave":"206","Name":"SAMORA CORREIA","Address":" Avenida do Século Lote 35 - Loja 31 Samora Correia","TIPO_DE_TRABALHO":"Integración","lat":38.93181,"lon":-8.87114,"gmapsAddress":"Avenida do Século, Lote 35, Samora Correia, Portugal"},
            {"clave":"208","Name":"MAFRA","Address":" Rua do Pinheiro Nº. 1 - Loja 1 Mafra","TIPO_DE_TRABALHO":"Integración","lat":38.93721,"lon":-9.32832,"gmapsAddress":"Rua do Pinheiro 1, Mafra, Portugal"},
            {"clave":"141","Name":"BENFICA","Address":"Alameda Manuel Ricardo Espírito Santo Nº. 2 Benfica","TIPO_DE_TRABALHO":"Integración","lat":38.742331,"lon":-9.205212,"gmapsAddress":"Alameda Manuel Ricardo Espírito Santo 2, Lisboa, Portugal"},
            {"clave":"168","Name":"LAGOS","Address":"Rua Francisco Xavier Ataíde Oliveira Lote 33 - Loja A Lagos","TIPO_DE_TRABALHO":"Integración","lat":37.1077,"lon":-8.6756,"gmapsAddress":"Rua Francisco Xavier Ataíde Oliveira, Lote 33, Lagos, Portugal"},
            {"clave":"182","Name":"LISBOA - AV. FONTES PEREIRA DE MELO","Address":"Av. Fontes Pereira de Melo Nº. 34-A/B Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.729,"lon":-9.1485,"gmapsAddress":"Av. Fontes Pereira de Melo 34, Lisboa, Portugal"},
            {"clave":"186","Name":"LISBOA - CAMPO DE OURIQUE","Address":"Rua Tomás da Anunciação Nº. 48-B Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7139,"lon":-9.1678,"gmapsAddress":"Rua Tomás da Anunciação 48-B, Lisboa, Portugal"},
            {"clave":"195","Name":"CHARNECA DA CAPARICA","Address":"Rua António Andrade E.N. 377 Nº. 1183 Charneca da Caparica","TIPO_DE_TRABALHO":"Integración","lat":38.6085,"lon":-9.1687,"gmapsAddress":"Rua António Andrade 1183, Charneca da Caparica, Portugal"},
            {"clave":"209","Name":"LISBOA - ALVALADE","Address":"Av. da Igreja Nº.17-D/E Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7514,"lon":-9.1465,"gmapsAddress":"Av. da Igreja 17, Lisboa, Portugal"},
            {"clave":"213","Name":"QUARTEIRA","Address":"Av. Dr. Francisco Sá Carneiro - Edfício Rei III R/C - Lojas C/D Quarteira","TIPO_DE_TRABALHO":"Integración","lat":37.0673,"lon":-8.0991,"gmapsAddress":"Av. Dr. Francisco Sá Carneiro, Quarteira, Portugal"},
            {"clave":"223","Name":"ODIVELAS","Address":"Avenida D. Dinis Nº. 108 Odivelas","TIPO_DE_TRABALHO":"Integración","lat":38.7942,"lon":-9.1764,"gmapsAddress":"Avenida D. Dinis 108, Odivelas, Portugal"},
            {"clave":"234","Name":"LISBOA - RUA DO OURO","Address":"Rua do Ouro Nºs. 142-146 Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7099,"lon":-9.1388,"gmapsAddress":"Rua do Ouro 142, Lisboa, Portugal"},
            {"clave":"243","Name":"SINES","Address":"Rua Marquês de Pombal Nº. 22 Sines","TIPO_DE_TRABALHO":"Integración","lat":37.9557,"lon":-8.8659,"gmapsAddress":"Rua Marquês de Pombal 22, Sines, Portugal"},
            {"clave":"248","Name":"TAVIRA","Address":"Rua da Liberdade Nº. 14 Tavira","TIPO_DE_TRABALHO":"Integración","lat":37.1265,"lon":-7.6496,"gmapsAddress":"Rua da Liberdade 14, Tavira, Portugal"},
            {"clave":"249","Name":"BARREIRO","Address":"Av. Alfredo da Silva Nº. 59 - R/C Barreiro","TIPO_DE_TRABALHO":"Integración","lat":38.662,"lon":-9.0747,"gmapsAddress":"Av. Alfredo da Silva 59, Barreiro, Portugal"},
            {"clave":"252","Name":"LISBOA- ANTONIO AUGUSTO AGUIAR","Address":"Av. António Augusto de Aguiar Nº.132 - PISO 1 Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7289,"lon":-9.155,"gmapsAddress":"Av. António Augusto de Aguiar 132, Lisboa, Portugal"},
            {"clave":"253","Name":"BEJA","Address":"Largo Escritor Manuel Ribeiro Nº. 10-A - R/C Beja","TIPO_DE_TRABALHO":"Integración","lat":38.0145,"lon":-7.8647,"gmapsAddress":"Largo Escritor Manuel Ribeiro 10, Beja, Portugal"},
            {"clave":"256","Name":"ESTREMOZ","Address":"Largo dos Combatentes da Grande Guerra Nº. 25 R/C Estremoz","TIPO_DE_TRABALHO":"Integración","lat":38.8427,"lon":-7.5878,"gmapsAddress":"Largo dos Combatentes da Grande Guerra 25, Estremoz, Portugal"},
            {"clave":"421","Name":"LISBOA - AV. REPÚBLICA","Address":"Av. da República Nº. 53-A - Edifício República Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7369,"lon":-9.1461,"gmapsAddress":"Av. da República 53, Lisboa, Portugal"},
            {"clave":"6310","Name":"LISBOA-Gabinete 1 - ED. FRONTEIRA","Address":"Av. António Augusto de Aguiar Nº.132 - PISO 1 Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7289,"lon":-9.155,"gmapsAddress":"Av. António Augusto de Aguiar 132, Lisboa, Portugal"},
            {"clave":"6320","Name":"LISBOA-Gabinete 2 - ED. FRONTEIRA","Address":"Av. António Augusto de Aguiar Nº.132 - PISO 1 Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7289,"lon":-9.155,"gmapsAddress":"Av. António Augusto de Aguiar 132, Lisboa, Portugal"},
            {"clave":"20140","Name":"FRONTEIRA (SEDE)","Address":"Av. António Augusto de Aguiar 132 Lisboa","TIPO_DE_TRABALHO":"Integración","lat":38.7289,"lon":-9.155,"gmapsAddress":"Av. António Augusto de Aguiar 132, Lisboa, Portugal"},
            {"clave":"27","Name":"SANTARÉM","Address":"Avenida D. Afonso Henriques Nº. 21 Santarém","TIPO_DE_TRABALHO":"Integración","lat":39.2323,"lon":-8.6853,"gmapsAddress":"Avenida D. Afonso Henriques 21, Santarém, Portugal"},
            {"clave":"37","Name":"OURÉM","Address":"Rua Dr. Neves Eliseu Nº. 25/27 Ourém","TIPO_DE_TRABALHO":"Integración","lat":39.645,"lon":-8.5908,"gmapsAddress":"Rua Dr. Neves Eliseu 25, Ourém, Portugal"},
            {"clave":"50","Name":"ALCOBAÇA","Address":"Avenida Prof. Engº Joaquim Vieira Natividade Alcobaça","TIPO_DE_TRABALHO":"Integración","lat":39.5517,"lon":-8.9772,"gmapsAddress":"Avenida Prof. Engº Joaquim Vieira Natividade, Alcobaça, Portugal"},
            {"clave":"54","Name":"QUELUZ","Address":"Avenida António Enes Nº. 25 Loja 301 Queluz","TIPO_DE_TRABALHO":"Integración","lat":38.7568,"lon":-9.2635,"gmapsAddress":"Avenida António Enes 25, Queluz, Portugal"},
            {"clave":"70","Name":"CASTELO BRANCO","Address":"Avenida 1º. de Maio N.º 60 Castelo Branco","TIPO_DE_TRABALHO":"Integración","lat":39.8231,"lon":-7.495,"gmapsAddress":"Avenida 1º de Maio 60, Castelo Branco, Portugal"},
            {"clave":"71","Name":"TORRES NOVAS","Address":"Avenida 8 de Julho Nº. 19 - R/C Direito Torres Novas","TIPO_DE_TRABALHO":"Integración","lat":39.4792,"lon":-8.5414,"gmapsAddress":"Avenida 8 de Julho 19, Torres Novas, Portugal"},
            {"clave":"77","Name":"CARTAXO","Address":"Av. João de Deus Lote 5 - R/C Esquerdo Cartaxo","TIPO_DE_TRABALHO":"Integración","lat":39.162,"lon":-8.7836,"gmapsAddress":"Av. João de Deus, Lote 5, Cartaxo, Portugal"},
            {"clave":"86","Name":"TORRES VEDRAS","Address":"Rua Dr. Carlos França Nº. 27 B - R/C Torres Vedras","TIPO_DE_TRABALHO":"Integración","lat":39.0918,"lon":-9.2581,"gmapsAddress":"Rua Dr. Carlos França 27B, Torres Vedras, Portugal"},
            {"clave":"91","Name":"VIMEIRO","Address":"Rua Principal Nº. 28 Vimeiro","TIPO_DE_TRABALHO":"Integración","lat":39.1985,"lon":-9.3208,"gmapsAddress":"Rua Principal 28, Vimeiro, Lourinhã, Portugal"},
            {"clave":"97","Name":"PAREDE","Address":"Rua Miguel Bombarda Nº. 413 - R/C Direito Parede","TIPO_DE_TRABALHO":"Integración","lat":38.6946,"lon":-9.3562,"gmapsAddress":"Rua Miguel Bombarda 413, Parede, Portugal"},
            {"clave":"101","Name":"CALDAS DA RAINHA","Address":"Av. 1º. de Maio Lote 24-A - Edifício D. Leonor Caldas da Rainha","TIPO_DE_TRABALHO":"Integración","lat":39.4018,"lon":-9.1364,"gmapsAddress":"Av. 1º de Maio, Lote 24-A, Caldas da Rainha, Portugal"},
            {"clave":"105","Name":"CASCAIS","Address":"Av. 25 de Abril Nº. 805 Cascais","TIPO_DE_TRABALHO":"Integración","lat":38.6974,"lon":-9.4168,"gmapsAddress":"Av. 25 de Abril 805, Cascais, Portugal"},
            {"clave":"108","Name":"CACÉM","Address":"Av. dos Bons Amigos Nº. 27-A Cacém","TIPO_DE_TRABALHO":"Integración","lat":38.7675,"lon":-9.2972,"gmapsAddress":"Av. dos Bons Amigos 27-A, Cacém, Portugal"},
            {"clave":"122","Name":"ALMEIRIM","Address":"Urbanização Quinta da Padilha Lote 4 Loja C Almeirim","TIPO_DE_TRABALHO":"Integración","lat":39.2125,"lon":-8.6212,"gmapsAddress":"Quinta da Padilha, Lote 4, Almeirim, Portugal"},
            {"clave":"137","Name":"FÁTIMA","Address":"Rotunda Norte – Terras Novas Edifício Nª. Srª. da Encarnação Nº. 260 - R/C Direito Fátima","TIPO_DE_TRABALHO":"Integración","lat":39.6309,"lon":-8.6531,"gmapsAddress":"Rotunda Norte 260, Fátima, Portugal"},
            {"clave":"224","Name":"BOMBARRAL","Address":"Largo dos Aviadores Nº. 21 - R/C Esquerdo Bombarral","TIPO_DE_TRABALHO":"Integración","lat":39.2662,"lon":-9.1578,"gmapsAddress":"Largo dos Aviadores 21, Bombarral, Portugal"},
            {"clave":"226","Name":"PENICHE","Address":"Av. 25 de Abril Nº. 76-A/B Peniche","TIPO_DE_TRABALHO":"Integración","lat":39.3551,"lon":-9.3791,"gmapsAddress":"Av. 25 de Abril 76, Peniche, Portugal"},
            {"clave":"229","Name":"VILA FRANCA DE XIRA","Address":"Avenida dos Combatentes da Grande Guerra Nº. 24 Vila Franca de Xira","TIPO_DE_TRABALHO":"Integración","lat":38.9542,"lon":-8.9897,"gmapsAddress":"Avenida dos Combatentes da Grande Guerra 24, Vila Franca de Xira, Portugal"},
            {"clave":"237","Name":"CARCAVELOS","Address":"Rua Sacadura Cabral Lote 3 - Loja 2 Carcavelos","TIPO_DE_TRABALHO":"Integración","lat":38.6874,"lon":-9.3323,"gmapsAddress":"Rua Sacadura Cabral, Lote 3, Carcavelos, Portugal"},
            {"clave":"239","Name":"LOURES","Address":"Rua da República Nº. 37-D Loures","TIPO_DE_TRABALHO":"Integración","lat":38.8285,"lon":-9.1714,"gmapsAddress":"Rua da República 37-D, Loures, Portugal"},
            {"clave":"244","Name":"ALGÉS","Address":"Av. dos Combatentes da Grande Guerra Nº.10-A/B/C Algés","TIPO_DE_TRABALHO":"Integración","lat":38.7001,"lon":-9.2312,"gmapsAddress":"Av. dos Combatentes da Grande Guerra 10, Algés, Portugal"},
            {"clave":"257","Name":"AMADORA","Address":"Rua Gonçalves Ramos Nº.52-A Amadora","TIPO_DE_TRABALHO":"Integración","lat":38.7523,"lon":-9.2351,"gmapsAddress":"Rua Gonçalves Ramos 52-A, Amadora, Portugal"},
            {"clave":"258","Name":"SERTÃ","Address":"Rua 1º. de dezembro Nº. 14 Sertã","TIPO_DE_TRABALHO":"Integración","lat":39.8038,"lon":-8.0991,"gmapsAddress":"Rua 1º de dezembro 14, Sertã, Portugal"},
            {"clave":"532","Name":"PÓVOA DE STA. IRIA","Address":"Av. Dom Vicente Afonso Valente 2625-095 Póvos de St. Iria","TIPO_DE_TRABALHO":"Integración","lat":38.8687,"lon":-9.0664,"gmapsAddress":"Av. Dom Vicente Afonso Valente, Póvoa de Santa Iria, Portugal"},
            {"clave":"6312","Name":"TORRES VEDRAS -Empresas","Address":"Rua Dr. Carlos França Nº. 27 B - R/C Torres Vedras","TIPO_DE_TRABALHO":"Integración","lat":39.0918,"lon":-9.2581,"gmapsAddress":"Rua Dr. Carlos França 27B, Torres Vedras, Portugal"},
            {"clave":"6312","Name":"SANTAREM EMPRESAS","Address":"Av. Bernardo Santareno 33 2005-177 Santarém","TIPO_DE_TRABALHO":"Integración","lat":39.2384,"lon":-8.6926,"gmapsAddress":"Av. Bernardo Santareno 33, 2005-177 Santarém, Portugal"},
            {"clave":"149","Name":"LOURINHÃ","Address":"Praça Coronel António Maria Baptista Edifício Augusto Antunes Loja Direita Lourinhã","TIPO_DE_TRABALHO":"Integración","lat":39.2435,"lon":-9.3113,"gmapsAddress":"Praça Coronel António Maria Baptista, Lourinhã, Portugal"},
            {"clave":"26","Name":"SETÚBAL","Address":"Avenida Alexandre Herculano Nº. 12 Setúbal","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.526279,"lon":-8.891157,"gmapsAddress":"Avenida Alexandre Herculano 12, Setúbal, Portugal"},
            {"clave":"119","Name":"LISBOA - AV. ROMA","Address":"Av. de Roma Nº. 36-C Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.745494,"lon":-9.143899,"gmapsAddress":"Av. de Roma 36-C, Lisboa, Portugal"},
            {"clave":"183","Name":"LISBOA - PARQUE DAS NAÇÕES","Address":"Av. D. João II Nº. 24 - R/C Direito C Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.766788,"lon":-9.096775,"gmapsAddress":"Av. D. João II 24, Lisboa, Portugal"},
            {"clave":"3000","Name":"BB LISBOA","Address":"Av. 5 de Outubro 48 1050-057 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.73602,"lon":-9.14891,"gmapsAddress":"Av. 5 de Outubro 48, 1050-057 Lisboa, Portugal"},
            {"clave":"3027","Name":"FARO","Address":"Av. 5 de Outubro 2 Letra B R/C 8000-076 Faro","TIPO_DE_TRABALHO":"Retirada de marca","lat":37.01859,"lon":-7.93608,"gmapsAddress":"Av. 5 de Outubro 2B, 8000-076 Faro, Portugal"},
            {"clave":"3056","Name":"ÉVORA","Address":"Av. de Lisboa 32 Horta dos Telhais Loja J 7000-719 Évora","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.57793,"lon":-7.91745,"gmapsAddress":"Av. de Lisboa 32, 7000-719 Évora, Portugal"},
            {"clave":"3061","Name":"REPUBLICA","Address":"Av. da República 20 A 1050-192 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.73289,"lon":-9.1466,"gmapsAddress":"Av. da República 20A, 1050-192 Lisboa, Portugal"},
            {"clave":"3088","Name":"CI CASTILHO 20","Address":"Rua Castilho 20 1º 1250-069 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7214,"lon":-9.15392,"gmapsAddress":"Rua Castilho 20, 1250-069 Lisboa, Portugal"},
            {"clave":"3097","Name":"CI LISBOA I","Address":"Rua Carlos Alberto Mota Pinto 1-2 1º andar 1070-046 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.72517,"lon":-9.16016,"gmapsAddress":"Rua Carlos Alberto Mota Pinto 1, 1070-046 Lisboa, Portugal"},
            {"clave":"3098","Name":"CI LISBOA II","Address":"Rua Carlos Alberto Mota Pinto 1-2 1º andar 1070-046 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.72517,"lon":-9.16016,"gmapsAddress":"Rua Carlos Alberto Mota Pinto 1, 1070-046 Lisboa, Portugal"},
            {"clave":"179","Name":"SINTRA","Address":"Avenida Movimento das Forças Armadas Nº. 42 - R/C Sintra","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7981,"lon":-9.3871,"gmapsAddress":"Avenida Movimento das Forças Armadas 42, Sintra, Portugal"},
            {"clave":"3010","Name":"ESTORIL","Address":"Av. Clotilde Ctro Congressos do Estoril 3-B lj A 2765-211 Estoril","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7066,"lon":-9.3973,"gmapsAddress":"Av. Clotilde 3B, 2765-211 Estoril, Portugal"},
            {"clave":"3045","Name":"TORRES NOVAS","Address":"Av. 8 Julho Bloc 2 Loja 5 Cond.Beira Rio 2350-724 Torres Novas","TIPO_DE_TRABALHO":"Retirada de marca","lat":39.4795,"lon":-8.5412,"gmapsAddress":"Av. 8 Julho, Bloco 2, 2350-724 Torres Novas, Portugal"},
            {"clave":"3046","Name":"TORRES VEDRAS","Address":"Rua António Leal D´ascensão 22 2560-309 Torres Vedras","TIPO_DE_TRABALHO":"Retirada de marca","lat":39.0924,"lon":-9.2599,"gmapsAddress":"Rua António Leal D´ascensão 22, 2560-309 Torres Vedras, Portugal"},
            {"clave":"701","Name":"LISBOA - AV. LIBERDADE","Address":"Av. da Liberdade Nº. 245 Loja 1 - R/C Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7208,"lon":-9.1462,"gmapsAddress":"Av. da Liberdade 245, Lisboa, Portugal"},
            {"clave":"3064","Name":"AUGUSTO AGUIAR","Address":"Av. António Augusto Aguiar 23 F 1050-016 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7265,"lon":-9.1523,"gmapsAddress":"Av. António Augusto Aguiar 23F, 1050-016 Lisboa, Portugal"},
            {"clave":"3091","Name":"LISBOA-CASTILHO 20","Address":"Rua Barata Salgueiro 43 1250-043 Lisboa","TIPO_DE_TRABALHO":"Retirada de marca","lat":38.7201,"lon":-9.1489,"gmapsAddress":"Rua Barata Salgueiro 43, 1250-043 Lisboa, Portugal"},
            {"clave":"3008","Name":"BB SETÚBAL","Address":"Praça do Bocage 42/43 2900-276 Setúbal","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.52445,"lon":-8.89201,"gmapsAddress":"Praça do Bocage 42, 2900-276 Setúbal, Portugal"},
            {"clave":"3012","Name":"SETÚBAL","Address":"Praça do Bocage 42/43 2900-276 Setúbal","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.52445,"lon":-8.89201,"gmapsAddress":"Praça do Bocage 42, 2900-276 Setúbal, Portugal"},
            {"clave":"3025","Name":"BELÉM","Address":"Rua de Belém 26 1300-084 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.69741,"lon":-9.20233,"gmapsAddress":"Rua de Belém 26, 1300-084 Lisboa, Portugal"},
            {"clave":"3032","Name":"TELHEIRAS","Address":"Rua Professor Vieira de Almeida 2 C 1600-664 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.76211,"lon":-9.17647,"gmapsAddress":"Rua Professor Vieira de Almeida 2C, 1600-664 Lisboa, Portugal"},
            {"clave":"3057","Name":"PORTIMÃO","Address":"Largo 1º de Dezembro 12 8500-538 Portimão","TIPO_DE_TRABALHO":"Ampliación de marca","lat":37.13783,"lon":-8.53723,"gmapsAddress":"Largo 1º de Dezembro 12, 8500-538 Portimão, Portugal"},
            {"clave":"3060","Name":"LARANJEIRAS","Address":"Estrada da Luz 90 1600-160 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.75167,"lon":-9.1729,"gmapsAddress":"Estrada da Luz 90, 1600-160 Lisboa, Portugal"},
            {"clave":"3481","Name":"FA INFANTE SANTO","Address":"Av. Infante Santo 66 C 1350-180 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.70783,"lon":-9.16911,"gmapsAddress":"Av. Infante Santo 66C, 1350-180 Lisboa, Portugal"},
            {"clave":"3909","Name":"FA ESTRELA","Address":"Av. Infante Santo 66 C 1350-180 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.70783,"lon":-9.16911,"gmapsAddress":"Av. Infante Santo 66C, 1350-180 Lisboa, Portugal"},
            {"clave":"3028","Name":"PARQUE NAÇÕES","Address":"Av. D. João II 37 A 1990-083 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7663,"lon":-9.09848,"gmapsAddress":"Av. D. João II 37A, 1990-083 Lisboa, Portugal"},
            {"clave":"3049","Name":"ROMA","Address":"Av. de Roma 50 F 1700-348 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7456,"lon":-9.14151,"gmapsAddress":"Av. de Roma 50F, 1700-348 Lisboa, Portugal"},
            {"clave":"3050","Name":"COLUMBANO","Address":"Av. Columbano Bordalo Pinheiro 75 B 1070-061 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.74102,"lon":-9.16782,"gmapsAddress":"Av. Columbano Bordalo Pinheiro 75B, 1070-061 Lisboa, Portugal"},
            {"clave":"3484","Name":"FA ALVALADE","Address":"Av. Santa Joana Princesa 12 C 1700-357 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7497,"lon":-9.13621,"gmapsAddress":"Av. Santa Joana Princesa 12C, 1700-357 Lisboa, Portugal"},
            {"clave":"3910","Name":"FA ENTRECAMPOS II","Address":"Av. Das Forças Armadas 4 C 4 D e 4 E 1600-082 Lisboa","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7483,"lon":-9.1558,"gmapsAddress":"Av. Das Forças Armadas 4, 1600-082 Lisboa, Portugal"},
            {"clave":"3018","Name":"CASCAIS","Address":"Av. 25 de Abril 901 Letra B 2750-515 Cascais","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.6978,"lon":-9.4182,"gmapsAddress":"Av. 25 de Abril 901B, 2750-515 Cascais, Portugal"},
            {"clave":"3048","Name":"OEIRAS","Address":"Rua Dr. José da Cunha 29 C 2780-263 Oeiras","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.6925,"lon":-9.3115,"gmapsAddress":"Rua Dr. José da Cunha 29C, 2780-263 Oeiras, Portugal"},
            {"clave":"3062","Name":"SINTRA","Address":"Largo Afonso de Albuquerque 18 2710-519 Sintra","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7974,"lon":-9.3905,"gmapsAddress":"Largo Afonso de Albuquerque 18, 2710-519 Sintra, Portugal"},
            {"clave":"3482","Name":"FA CASCAIS","Address":"Av. D. Carlos I nº 212 2750-310 Cascais","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7011,"lon":-9.4179,"gmapsAddress":"Av. D. Carlos I 212, 2750-310 Cascais, Portugal"},
            {"clave":"3483","Name":"FA LINDA-A-VELHA","Address":"Av. 25 de Abril de 1974 - Central Plaza 1 C 2795-247 Linda-a-Velha","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7118,"lon":-9.2435,"gmapsAddress":"Av. 25 de Abril de 1974 1C, 2795-247 Linda-a-Velha, Portugal"},
            {"clave":"3487","Name":"FA MEM MARTINS","Address":"Rua do Coudel nº 41 B 2725-277 Mem Martins","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7845,"lon":-9.3361,"gmapsAddress":"Rua do Coudel 41B, 2725-277 Mem Martins, Portugal"},
            {"clave":"3488","Name":"FA MONTE ESTORIL","Address":"Av. Sabóia Lote 914 A 2765-579 Monte Estoril","TIPO_DE_TRABALHO":"Ampliación de marca","lat":38.7075,"lon":-9.4088,"gmapsAddress":"Av. Sabóia, Lote 914A, 2765-579 Monte Estoril, Portugal"},
            {"clave":"3491","Name":"FA SANTARÉM","Address":"Av. Bernardo Santareno nº 35 R/C Dto 2005-177 Santarém","TIPO_DE_TRABALHO":"Ampliación de marca","lat":39.2386,"lon":-8.6929,"gmapsAddress":"Av. Bernardo Santareno 35, 2005-177 Santarém, Portugal"},
            {"clave":"0925-06","Name":"APL - ADMINISTração DO PORTO DE LISBOA","Address":"Edifício Infante D. Henrique Doca de Alcântara SN Lisboa","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":38.701199,"lon":-9.168393,"gmapsAddress":"Doca de Alcântara, Lisboa, Portugal"},
            {"clave":"0925-23","Name":"CAMPING VILLA PARK ZAMBUJEIRA","Address":"Camping Villa Park Zambujeira 7630-740 Zambujeira do Mar","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":37.521873,"lon":-8.777096,"gmapsAddress":"Camping Villa Park, Zambujeira do Mar, Portugal"},
            {"clave":"0925-15","Name":"TINTAS ROBBIALAC","Address":"Rua Vale de Lide s/n Sao Joao da Talha","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":38.824209,"lon":-9.08864,"gmapsAddress":"Rua Vale de Lide, Sao Joao da Talha, Portugal"},
            {"clave":"0925-50","Name":"Marina Albufeira","Address":"Alameda da Orada 6 Albufeira","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":37.08588,"lon":-8.26715,"gmapsAddress":"Alameda da Orada 6, Albufeira, Portugal"},
            {"clave":"0925-01","Name":"CC ASSUNÇÃO","Address":"R. António Silva 127 A - Bairro Assunção Cascais","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":38.708323,"lon":-9.412191,"gmapsAddress":"Rua António Silva 127A, Cascais, Portugal"},
            {"clave":"0930-09","Name":"HOSPITAL PRIVADO DE SANTARÉM (CUF)","Address":"R. Zeferino Silva 39 2005-321 Santarém","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":39.22722,"lon":-8.69472,"gmapsAddress":"Rua Zeferino Silva 39, 2005-321 Santarém, Portugal"},
            {"clave":"0925-48","Name":"MADORNA - FARMÁCIA","Address":"Av. Francisca Lindoso 236E 2785-451 São Domingos de Rana","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":38.7081,"lon":-9.3364,"gmapsAddress":"Av. Francisca Lindoso 236E, 2785-451 São Domingos de Rana, Portugal"},
            {"clave":"0925-12","Name":"PASTELARIA ARIZONA RIO MOURO","Address":"R.Barbosa do Bocage 16 Rio de Mouro","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":38.7744,"lon":-9.3304,"gmapsAddress":"Rua Barbosa do Bocage 16, Rio de Mouro, Portugal"},
            {"clave":"0930-25","Name":"SERTÃ - SUPERMERCADOS (INTERMARCHÉ)","Address":"São João do Couto Sertã","TIPO_DE_TRABALHO":"Integración de Cajeros","lat":39.8038,"lon":-8.0991,"gmapsAddress":"Intermarché, Sertã, Portugal"},
            {"clave":"3026","Name":"AMOREIRAS","Address":"Rua Carlos Alberto da Mota Pinto 1 1070-046 Lisboa","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":38.72517,"lon":-9.16016,"gmapsAddress":"Rua Carlos Alberto da Mota Pinto 1, 1070-046 Lisboa, Portugal"},
            {"clave":"3485","Name":"FA ALTO DOS MOINHOS","Address":"Rua Abílio Mendes nº 14 B 1500-458 Lisboa","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":38.7512,"lon":-9.1895,"gmapsAddress":"Rua Abílio Mendes 14B, 1500-458 Lisboa, Portugal"},
            {"clave":"3486","Name":"FA LUMIAR","Address":"Alameda das Linhas de Torres 160A 1750-479 Lisboa","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":38.7753,"lon":-9.1632,"gmapsAddress":"Alameda das Linhas de Torres 160A, 1750-479 Lisboa, Portugal"},
            {"clave":"3490","Name":"FA PORTALEGRE","Address":"Rua 1º de Maio nº 11 7300-126 Portalegre","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":39.2921,"lon":-7.4295,"gmapsAddress":"Rua 1º de Maio 11, 7300-126 Portalegre, Portugal"},
            {"clave":"3912","Name":"FA ALMADA","Address":"Rua Caetano Maria Batalha 2B 2800-039 Almada","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":38.6781,"lon":-9.1633,"gmapsAddress":"Rua Caetano Maria Batalha 2B, 2800-039 Almada, Portugal"},
            {"clave":"3489A","Name":"FA ALJUSTREL","Address":"Av. Liberdade 35 7600-014 Aljustrel","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":37.8745,"lon":-8.1691,"gmapsAddress":"Av. da Liberdade 35, 7600-014 Aljustrel, Portugal"},
            {"clave":"3911A","Name":"FA TORRES VEDRAS","Address":"Avenida da Liberdade 2B 2560-271 Torres Vedras","TIPO_DE_TRABALHO":"Cambio de BH-TA","lat":39.092,"lon":-9.2605,"gmapsAddress":"Avenida da Liberdade 2B, 2560-271 Torres Vedras, Portugal"}
        ];
        
        // --- MAP AND UI ELEMENTS ---
        let map;
        let routeLayerGroup;
        const workTypeContainer = document.getElementById('work-type-filters');
        const zoneContainer = document.getElementById('zone-filters');
        const generateBtn = document.getElementById('generate-route-btn');
        const routeListEl = document.getElementById('route-list');
        const routeSummaryEl = document.getElementById('route-summary');
        const loadingSpinner = document.getElementById('loading-spinner');
        const searchIcon = document.getElementById('search-icon');

        // --- ZONES DEFINITION ---
        const casteloBrancoLat = 39.8231;
        const faroLat = 37.016335;
        const kmInLatitudeDegree = 111.32; // Approximate km per degree of latitude
        const boundaryOffset = 105 / kmInLatitudeDegree; // ~0.943 degrees

        // The southern boundary of the North zone is 105km south of Castelo Branco's latitude
        const northZoneBoundary = casteloBrancoLat - boundaryOffset; 

        // The northern boundary of the South zone is 105km north of Faro's latitude
        const southZoneBoundary = faroLat + boundaryOffset;

        let ZONES = {
            'north': { name: 'Norte', minLat: northZoneBoundary, maxLat: 90, minLon: -180, maxLon: 180 },
            'center': { name: 'Centro', minLat: southZoneBoundary, maxLat: northZoneBoundary, minLon: -180, maxLon: 180 },
            'south': { name: 'Sur', minLat: -90, maxLat: southZoneBoundary, minLon: -180, maxLon: 180 },
            'lisbon_north': { name: 'Gran Lisboa - Norte', minLat: 38.78, maxLat: 39.0, minLon: -9.3, maxLon: -9.05 },
            'lisbon_center': { name: 'Gran Lisboa - Centro', minLat: 38.70, maxLat: 38.78, minLon: -9.25, maxLon: -9.05 },
            'south_bank': { name: 'Margen Sur / Setúbal', minLat: 38.4, maxLat: 38.70, minLon: -9.2, maxLon: -8.8 },
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            populateFilters();
            setupEventListeners();
        });

        function setupEventListeners() {
            generateBtn.addEventListener('click', () => handleGenerateRoute());
            const drawBtn = document.getElementById('draw-area-btn');
            drawBtn.addEventListener('click', toggleDrawingMode);
            
            // Map drawing listeners
            map.on('click', onMapClickForDraw);
            map.on('mousemove', onMapMouseMoveForDraw);
            map.on('dblclick', completeDrawing);
        }

        function initMap() {
            map = L.map('map').setView([39.5, -8.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            routeLayerGroup = L.layerGroup().addTo(map);
        }

        function populateFilters() {
            // Work Type Filter
            workTypeContainer.innerHTML = '';
            const workTypes = [...new Set(LOCATIONS.map(loc => loc.TIPO_DE_TRABALHO))];
            createCheckboxGroup(workTypeContainer, 'Todos los Tipos', 'all-work-types', workTypes.map(wt => ({ value: wt, label: wt })));

            // Zone Filter
            zoneContainer.innerHTML = '';
             const zoneOptions = Object.entries(ZONES)
                .map(([key, value]) => ({ value: key, label: value.name }));
            createCheckboxGroup(zoneContainer, 'Todas las Zonas', 'all-zones', zoneOptions);
        }
        
        function createCheckboxGroup(container, allLabel, allId, options) {
            // "Select All" checkbox
            container.innerHTML += `
                <div class="flex items-center border-b pb-2 mb-2">
                    <input id="${allId}" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 font-bold">
                    <label for="${allId}" class="ml-2 block text-sm text-gray-900 font-semibold">${allLabel}</label>
                </div>
            `;

            // Other checkboxes
            options.forEach(opt => {
                const id = `${container.id}-${opt.value.replace(/\s+/g, '-')}`;
                container.innerHTML += `
                    <div class="flex items-center">
                        <input id="${id}" data-type="option" type="checkbox" checked value="${opt.value}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="${id}" class="ml-2 block text-sm text-gray-900">${opt.label}</label>
                    </div>
                `;
            });

            // Add event listeners
            const allCheckbox = container.querySelector(`#${allId}`);
            const optionCheckboxes = container.querySelectorAll('[data-type="option"]');

            allCheckbox.addEventListener('change', () => {
                optionCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
            });

            optionCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!cb.checked) {
                        allCheckbox.checked = false;
                    } else if ([...optionCheckboxes].every(optCb => optCb.checked)) {
                        allCheckbox.checked = true;
                    }
                });
            });
        }


        // --- CORE LOGIC ---
        function handleGenerateRoute(options = {}) {
            toggleLoading(true);
            routeLayerGroup.clearLayers();
            updateGoogleMapsLink([]); // Hide button while generating

            setTimeout(() => { // Simulate processing time for better UX
                const selectedWorkTypes = Array.from(workTypeContainer.querySelectorAll('input[type="checkbox"][data-type="option"]:checked')).map(cb => cb.value);
                
                // 1. Filter locations
                let filteredLocations;

                if (options.polygon) {
                     filteredLocations = LOCATIONS.filter(loc => {
                        const workTypeMatch = selectedWorkTypes.includes(loc.TIPO_DE_TRABALHO);
                        const point = L.latLng(loc.lat, loc.lon);
                        return workTypeMatch && isPointInPolygon(point, options.polygon);
                    });
                } else {
                    const selectedZoneKeys = Array.from(zoneContainer.querySelectorAll('input[type="checkbox"][data-type="option"]:checked')).map(cb => cb.value);
                    const isAllZonesChecked = document.getElementById('all-zones').checked;
                    
                    filteredLocations = LOCATIONS.filter(loc => {
                        const workTypeMatch = selectedWorkTypes.includes(loc.TIPO_DE_TRABALHO);
                        if (!workTypeMatch) return false;

                        if (isAllZonesChecked) return true;

                        const zoneMatch = selectedZoneKeys.some(zoneKey => {
                            const zone = ZONES[zoneKey];
                            if (!zone) return false;
                            return loc.lat >= zone.minLat && loc.lat <= zone.maxLat && loc.lon >= zone.minLon && loc.lon <= zone.maxLon;
                        });
                        
                        return zoneMatch;
                    });
                }


                if (filteredLocations.length === 0) {
                    routeSummaryEl.innerHTML = `<strong>0 paradas.</strong> No se encontraron ubicaciones para los filtros seleccionados.`;
                    routeListEl.innerHTML = '';
                    toggleLoading(false);
                    return;
                }
                
                // 2. Optimize route
                const { orderedRoute, totalDistance } = optimizeRoute(filteredLocations);

                // 3. Display route
                displayRoute(orderedRoute, totalDistance);
                toggleLoading(false);
            }, 500);
        }

        function optimizeRoute(locations) {
            let remaining = [...locations];
            let orderedRoute = [];
            let totalDistance = 0;

            if (remaining.length === 0) return { orderedRoute, totalDistance };

            // Start with the northernmost point
            let currentPoint = remaining.sort((a, b) => b.lat - a.lat)[0];
            orderedRoute.push(currentPoint);
            remaining = remaining.filter(loc => loc.clave !== currentPoint.clave || loc.Address !== currentPoint.Address);

            while (remaining.length > 0) {
                let nearest = null;
                let minDistance = Infinity;

                for (const nextPoint of remaining) {
                    const distance = haversineDistance(currentPoint, nextPoint);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = nextPoint;
                    }
                }
                
                totalDistance += minDistance;
                currentPoint = nearest;
                orderedRoute.push(currentPoint);
                remaining = remaining.filter(loc => loc.clave !== currentPoint.clave || loc.Address !== currentPoint.Address);
            }
            return { orderedRoute, totalDistance };
        }
        
        // --- DISPLAY AND UI FUNCTIONS ---
        function displayRoute(route, distance) {
            routeListEl.innerHTML = '';
            const latLngs = [];
            const createdMarkers = {}; // Keep track of markers using "lat,lon" as key

            route.forEach((loc, index) => {
                const markerKey = `${loc.lat},${loc.lon}`;
                latLngs.push([loc.lat, loc.lon]);

                if (!createdMarkers[markerKey]) {
                    const officesAtSameLocation = route.filter(p => p.lat === loc.lat && p.lon === loc.lon);
                    const popupContent = officesAtSameLocation.map(office => 
                        `<b>${office.clave} - ${office.Name.trim()}</b><br>${office.Address.trim()}<br><em>${office.TIPO_DE_TRABALHO}</em>`
                    ).join('<hr style="margin: 5px 0;">');
                    const marker = L.marker([loc.lat, loc.lon]).addTo(routeLayerGroup);
                    marker.bindPopup(popupContent);
                    createdMarkers[markerKey] = marker;
                }

                const li = document.createElement('li');
                li.className = 'p-2 border-b hover:bg-gray-50 cursor-pointer';
                li.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-6 w-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs font-bold">${index + 1}</div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">${loc.clave} - ${loc.Name.trim()}</p>
                            <p class="text-xs text-gray-500">${loc.Address.trim()}</p>
                            <p class="text-xs text-indigo-600 italic mt-1">${loc.TIPO_DE_TRABALHO}</p>
                        </div>
                    </div>
                `;
                li.addEventListener('click', () => {
                    map.setView([loc.lat, loc.lon], 15);
                    const marker = createdMarkers[markerKey];
                    if (marker) marker.openPopup();
                });
                routeListEl.appendChild(li);
            });


            if (route.length > 1) L.polyline(latLngs, { color: 'indigo' }).addTo(routeLayerGroup);
            if(latLngs.length > 0) map.fitBounds(L.latLngBounds(latLngs), { padding: [50, 50] });

            routeSummaryEl.innerHTML = `<strong>${route.length} paradas.</strong> Distancia total estimada: <strong>${distance.toFixed(2)} km</strong>.`;
            updateGoogleMapsLink(route);
        }

        function updateGoogleMapsLink(route) {
            const googleMapsBtn = document.getElementById('google-maps-btn');
            if (route.length < 1) {
                googleMapsBtn.classList.add('hidden');
                return;
            }

            let googleMapsUrl;
            if (route.length === 1) {
                const address = encodeURIComponent(route[0].gmapsAddress.trim());
                googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${address}`;
            } else {
                const waypoints = route.map(loc => encodeURIComponent(loc.gmapsAddress.trim())).join('/');
                googleMapsUrl = `https://www.google.com/maps/dir/${waypoints}`;
            }
            
            googleMapsBtn.href = googleMapsUrl;
            googleMapsBtn.classList.remove('hidden');
        }

        function toggleLoading(isLoading) {
            generateBtn.disabled = isLoading;
            generateBtn.classList.toggle('cursor-not-allowed', isLoading);
            generateBtn.classList.toggle('bg-indigo-400', isLoading);
            loadingSpinner.classList.toggle('hidden', !isLoading);
            searchIcon.classList.toggle('hidden', isLoading);
        }
        
        // --- MAP DRAWING ---
        let isDrawing = false;
        let drawnPoints = [];
        let drawingLayerGroup = L.layerGroup();
        let tempLine = null;
        let firstMarker = null;

        function toggleDrawingMode() {
            isDrawing = !isDrawing;
            const drawBtn = document.getElementById('draw-area-btn');
            
            if (isDrawing) {
                drawingLayerGroup.clearLayers();
                drawnPoints = [];
                firstMarker = null;
                if(map.hasLayer(drawingLayerGroup)) map.removeLayer(drawingLayerGroup);
                drawingLayerGroup.addTo(map);

                L.DomUtil.addClass(map._container,'crosshair-cursor-enabled');
                drawBtn.textContent = 'Cancelar Dibujo';
                drawBtn.classList.remove('bg-white', 'text-gray-800');
                drawBtn.classList.add('bg-red-500', 'text-white');
            } else {
                L.DomUtil.removeClass(map._container,'crosshair-cursor-enabled');
                drawBtn.textContent = 'Dibujar Área en Mapa';
                drawBtn.classList.add('bg-white', 'text-gray-800');
                drawBtn.classList.remove('bg-red-500', 'text-white');
                
                if (tempLine) {
                    map.removeLayer(tempLine);
                    tempLine = null;
                }
                drawingLayerGroup.clearLayers();
            }
        }

        function onMapClickForDraw(e) {
            if (!isDrawing) return;

            drawnPoints.push(e.latlng);

            const markerOptions = {
                radius: 6,
                fillColor: '#ffffff',
                color: '#4385f5',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            };
            
            if (drawnPoints.length === 1) {
                 markerOptions.fillColor = '#f4b400';
                 markerOptions.radius = 8;
                 firstMarker = L.circleMarker(e.latlng, markerOptions).addTo(drawingLayerGroup);
                 firstMarker.bindTooltip("Haga clic aquí para cerrar el área").openTooltip();
                 firstMarker.on('click', completeDrawing);
            } else {
                L.circleMarker(e.latlng, markerOptions).addTo(drawingLayerGroup);
            }
            
            if (drawnPoints.length > 1) {
                drawingLayerGroup.eachLayer(layer => {
                    if(layer instanceof L.Polyline) layer.remove();
                });
                L.polyline(drawnPoints, { color: '#4385f5' }).addTo(drawingLayerGroup);
            }
        }

        function onMapMouseMoveForDraw(e) {
            if (!isDrawing || drawnPoints.length === 0) return;
            
            if (tempLine) {
                map.removeLayer(tempLine);
            }
            
            const lastPoint = drawnPoints[drawnPoints.length - 1];
            tempLine = L.polyline([lastPoint, e.latlng], {
                color: '#4385f5',
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
        }

        function completeDrawing() {
            if (!isDrawing || drawnPoints.length < 3) return;
            
            if(tempLine) map.removeLayer(tempLine);
            const polygon = L.polygon(drawnPoints);
            handleGenerateRoute({ polygon: polygon });
            
            toggleDrawingMode();
        }

        function isPointInPolygon(point, polygon) {
            const latlngs = polygon.getLatLngs()[0];
            if (!latlngs || latlngs.length === 0) return false;
            let inside = false;
            let x = point.lng, y = point.lat;

            for (let i = 0, j = latlngs.length - 1; i < latlngs.length; j = i++) {
                let xi = latlngs[i].lng, yi = latlngs[i].lat;
                let xj = latlngs[j].lng, yj = latlngs[j].lat;

                let intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }

            return inside;
        }

        // --- HELPER FUNCTIONS ---
        function haversineDistance(coords1, coords2) {
            function toRad(x) { return x * Math.PI / 180; }
            const R = 6371; // Earth's radius in km
            const dLat = toRad(coords2.lat - coords1.lat);
            const dLon = toRad(coords2.lon - coords1.lon);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(toRad(coords1.lat)) * Math.cos(toRad(coords2.lat)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>
</html>

